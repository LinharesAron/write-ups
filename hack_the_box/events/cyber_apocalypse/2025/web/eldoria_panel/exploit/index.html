<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>FileSaver Async Script Demo</title>
</head>
<body>
  <h1>FileSaver Async Script Demo</h1>

  <script>
    window.addEventListener("load", function() {
      var url = '/phar';
      var callback = function(byteArray) {
        console.log('Callback called; byteArray length is:', byteArray.length);
      };

      var script = document.createElement('script');
      script.type = 'text/javascript';
      
      script.src = '//cdn.jsdelivr.net/g/filesaver.js';
      script.onload = function() {
        console.log((new Date().toString()) + ' : FileSaver Script is ready!');

        var fileNameOfFileSaver = '__PHAR_NAME__';
        var xhr = new XMLHttpRequest();
        xhr.open('GET', url, true);
        xhr.responseType = 'arraybuffer';

        xhr.onload = function() {
          var arrayBuffer = xhr.response;
          var byteArray = new Uint8Array(arrayBuffer);

          console.log((new Date().toString()) + ' : byteArray length > 30M, actually ' + byteArray.length + ' bytes. Saving locally...');
            const blob = new Blob([byteArray], {
              type: 'application/octet-stream'
            });
            saveAs(blob, fileNameOfFileSaver);

            byteArray = (new TextEncoder()).encode(
              'ExecuteAsyncScript Successfully, File Saved to |' + fileNameOfFileSaver + '| (' + byteArray.length + ' bytes)'
            );

          callback(byteArray);
        };

        xhr.send();
      };

      document.head.appendChild(script);
    });
  </script>
</body>
</html>
